<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Login</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 2em auto; }
    label, input { display: block; width: 100%; margin-bottom: .5em; }
    #error {
      color: red;
      white-space: pre-wrap;
      margin-bottom: 1em;
    }
    /* Pulsante uniformato agli altri form */
    button {
      display: block;
      width: 100%;
      margin-bottom: 1em;
      font-size: 1rem;
      padding: 0.75em;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Login</h1>
  <div id="error"></div>

  <form id="loginForm">
    <label for="email">Email</label>
    <input id="email" type="email" required />

    <label for="password">Password</label>
    <input id="password" type="password" required />

    <button type="submit">Login</button>
  </form>

  <script>
    const errorEl = document.getElementById('error');

    function showError(message) {
      errorEl.textContent = message;
    }

    document.getElementById('loginForm').addEventListener('submit', async function(evt) {
      evt.preventDefault();
      errorEl.textContent = '';

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(
          'https://3we4sfdvrh.execute-api.us-east-1.amazonaws.com/dev/login',
          {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          }
        );

        const text = await res.text();
        const payload = (() => {
          try { return JSON.parse(text); }
          catch { return { error: text }; }
        })();

        if (!res.ok) {
          throw new Error(payload.error || `HTTP ${res.status}`);
        }

        const { idToken, accessToken } = payload;
        localStorage.setItem('idToken', idToken);
        localStorage.setItem('accessToken', accessToken);

        // decode JWT
        const parseJwt = t => JSON.parse(window.atob(t.split('.')[1]));
        const claims = parseJwt(idToken);
        const groups = claims['cognito:groups'] || [];

        // decide redirect
        let redirectUrl = null;
        if (groups.includes('Admin')) {
          redirectUrl = 'https://frontend-heartbeat-copy.s3.us-east-1.amazonaws.com/adminHome.html';
        } else if (groups.includes('Doctor')) {
          redirectUrl = 'https://frontend-heartbeat-copy.s3.us-east-1.amazonaws.com/doctorHome.html';
        } else if (groups.includes('Patient')) {
          redirectUrl = 'https://frontend-heartbeat-copy.s3.us-east-1.amazonaws.com/patientHome.html';
        }

        if (redirectUrl) {
          window.location.replace(redirectUrl);
        } else {
          showError('User not authorized or not belonging to a valid group.');
        }

      } catch (err) {
        showError(`[${err.name}] ${err.message}`);
      }
    });
  </script>
</body>
</html>
